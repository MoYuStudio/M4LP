# M4LP 轮子驱动修改说明

## 修改概述

根据您的需求，我们将M4LP四足机器人模型修改为轮子驱动模式，其中：
- 四个脚的前端是轮子，用于驱动移动
- 四足主要用于保持整体稳定和适应不同地形
- 移除了四足行走步态，改为轮子驱动

## 具体修改内容

### 1. URDF文件修改 (m4lp.urdf)

**修改的关节类型：**
- 将所有轮子关节从 `type="fixed"` 改为 `type="continuous"`
- 添加了轮子旋转轴 `axis xyz="0 0 1"`
- 设置了轮子控制参数 `limit effort="20" velocity="50"`

**影响的关节：**
- FL_wheel_joint (前左轮)
- FR_wheel_joint (前右轮)  
- RL_wheel_joint (后左轮)
- RR_wheel_joint (后右轮)

**物理属性设置：**
- 在环境代码中为轮子添加了摩擦系数
- lateralFriction=1.0 (侧向摩擦)
- spinningFriction=0.1 (旋转摩擦)  
- rollingFriction=0.01 (滚动摩擦)

### 2. 环境控制修改 (m4lp_env.py)

**观测空间调整：**
- 从33维调整为32维
- 包含：基础状态(3) + 姿态(6) + 关节位置(8) + 关节速度(8) + 轮子速度(4) + 目标速度(3)

**动作空间调整：**
- 保持12维：髋关节(4) + 膝盖关节(4) + 轮子速度(4)
- 动作范围从[-0.3, 0.3]调整为[-1.0, 1.0]

**控制策略：**
- 前8个动作：关节位置控制，用于稳定姿态
- 后4个动作：轮子速度控制，用于驱动移动
- 关节控制：小幅调整，主要维持稳定
- 轮子控制：直接速度控制，实现移动

**奖励函数优化：**
- 主要奖励：移动速度匹配 (权重2.0)
- 稳定性奖励：保持水平姿态 (权重0.3)
- 能耗惩罚：关节和轮子能耗 (权重0.1, 0.05)
- 摔倒惩罚：严重惩罚 (权重2.0)

### 3. 主脚本修改 (main.py)

**控制策略：**
- 移除了四足行走步态函数
- 新增轮子驱动和稳定控制函数
- 轮子控制：根据目标速度设置轮子角速度
- 四足控制：根据机器人姿态调整关节位置保持稳定

**稳定控制逻辑：**
- 根据滚转角度调整髋关节（左右稳定）
- 根据俯仰角度调整膝盖关节（前后稳定）
- 实时响应姿态变化，保持机器人稳定

### 4. 新增测试文件 (test_wheel_drive.py)

**测试内容：**
- 验证轮子关节可以独立旋转
- 测试所有轮子同时驱动
- 测试四足稳定功能
- 测试单个轮子控制

## 使用方法

### 运行主程序
```bash
python main.py
```

### 运行环境测试
```bash
python -c "from m4lp_env import M4LPEnv; env = M4LPEnv(render_mode='human'); obs, info = env.reset(); print('观测空间:', obs.shape); env.close()"
```

### 运行轮子测试
```bash
python test_wheel_drive.py
```

### 运行轮子滚动测试
```bash
python test_wheel_rolling.py
```

### 运行演示程序
```bash
python demo_wheel_rolling.py
```

## 技术特点

1. **轮子滚动驱动**：四个轮子可以独立控制，在地面上滚动推动机器人移动
2. **四足稳定**：四足关节根据姿态实时调整，保持机器人稳定
3. **适应性强**：可以在不同地形上保持稳定移动
4. **能耗优化**：奖励函数鼓励节能的关节和轮子使用
5. **实时控制**：支持实时姿态调整和速度控制
6. **物理真实**：轮子与地面有真实的摩擦接触，实现真实的滚动效果

## 控制参数

- 轮子速度缩放：10.0 (动作值 × 10.0 = 轮子角速度)
- 关节调整幅度：0.1 (动作值 × 0.1 = 关节位置调整)
- 稳定控制增益：0.5 (姿态误差 × 0.5 = 关节调整)
- 控制频率：50Hz (每20ms更新一次)

这个修改后的模型现在完全符合您的需求：轮子用于驱动移动，四足用于保持稳定和适应地形。
